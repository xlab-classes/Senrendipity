<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">


<head>
    <meta charset="UTF-8">
    <link href="chat-style.css" rel="stylesheet" type="text/css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="script.js"> </script>
    <title>Serendipity</title>

    <script>
        $(function(){
            var current_user = window.atob(getURLVariable("u"));
            var target_user = window.atob(getURLVariable("u2"));
            var room = toolnum(getURLVariable("r"));

            var message_id=0;
            var friend_show=0;
            detect_new_message();


            $("#send_message_button").keypress(function(event) {
                //用户按下回车键时，发送聊天消息
                if (event.keyCode === 13) {
                    //获取聊天消息的内容
                    //发送到服务器端
                    send_message()
                }
            })

            function detect_new_message(){
                console.log("room:"+room);

                $.post("post_check",{"user":current_user,"room":String(room),"last":String(message_id)},function(response){
                    // response > 0, let it get the new messages
                    //console.log("res:"+ response);
                    if(response !=="0" ) {
                        // run to get new messages
                        //console.log("run show message")
                        show_new_messages();

                    }
                    else {
                        //console.log("listening")
                    }
                },"text");
                setTimeout(detect_new_message, 1000);
            }


            function show_new_messages(){
                $.get("get_check",{"user":current_user,"room":room,"last":String(message_id)},function(response){

                    var data = JSON.parse(response)
                    var sender = data["sender"];
                    var receiver = data["receiver"]; // 加对方的名字
                    var message = data["message"];

                    for(let i = 0; i < sender.length; i++) {

                        if(username===sender[i]){ //右边的消息框
                            const html_message = "<li class='message_send'>" + message[i] + "</li>";
                            $("#chat_message").append(html_message);
                        }

                        else { // 左边的消息框
                            const html_message2 = "<li class='message_receive'>" + message[i] + "</li>";
                            $("#chat_message").append(html_message2);
                        }
                    }
                    //console.log("messege_id before ="+ message_id);
                    message_id += sender.length;
                    //console.log("messege_id after ="+ message_id);
                },"text");
            }


            function detect_friend_list(){
                $.post("detect_friend",{"user":current_user,"last":String(friend_show)},function(response){
                    if(response !=="0" ) {
                        show_new_friend();
                    }
                },"text");
                setTimeout(detect_friend_list, 1000);
            }

            function show_new_friend() {
                $.get("get_check",{"user":current_user,"last":String(friend_show)},function(response){
                    var data = JSON.parse(response)
                    var  friend= data["friend"];
                    var  last_messsage = data["message"]
                    for(let i = 0; i < friend.length; i++) {

                        const html_message = "<li class='friend_list'>" + "<p class='friend_username'>" +friend[i]+ "</p>"+ "<p class='last_message'>"+ last_messsage+ "</p>" +"</li>";
                        $("#friend_list").append(html_message);
                    };

                });

            }


        })



    </script>


</head><!--这个chat_detector () 等friend——list做出后， 在那加载chat_detector ()-->

<body class="bodybackgound" >
<div class="divALL">
    <button onclick="window.location.href ='match.html'" class="logo"></button>
    <div class="div_Notice_Friend_Box">
        <button class="button_addFriend"></button>
        <button class="button_newFriend">NEW</button>
    </div>

    <input type="text" id="search_box" class="div_search_box" placeholder="Search...">

    <div  class="div_Friend_List">
        <tr id="friend_list">
            <li class="friend_list">
                <p class="friend_username">FRIEND1</p>
                <p class="last_message"> Last message</p>
            </li>
            <li class="friend_list">
                <p class="friend_username">FRIEND2</p>
                <p class="last_message"> Last message</p></li>
        </tr>

    </div>


    <div class="div_button_three_dot">
        <button class="button_three_dot"> </button>
    </div>

    <div class="div_Friend_Chat_Name">
        <div class="div_CHATNAME_FriendPIC"></div>
        <p class="text_CHATNAME_FriendUsername"> FRIEND_USERNAME </p>
    </div>

    <div class="div_chat">
        <div class="div_chat2">   <!-- message -->
            <ul id="chat_message">
<!--                <li class="message_send ">hi</li>-->
<!--                <li class="message_receive ">hello</li>-->
            </ul>
        </div>

        <div class="div_chatinput">
            <input id= "message_input" type="text" placeholder="Write a message"  class="chat_input">

            <button class="button_file"></button>
            <button class="button_emoji"></button>
            <button id="send_message_button" onclick="send_message()" class="button_send"></button>

        </div>
    </div>

    <div class="div_selfInfo">
        <div class="div_selfPic"></div>
        <p class="text_username">USERNAME</p>
        <button class="button_setting"></button>
    </div>

    <div class="div_friend_Hobbies">
        <div class="div_friend_Hobbies_info">
            <div class="div_habitFriendPIC"> </div>
            <div class="div_Text_FRIEND_USERNAME"> <p> FRIEND USERNAME </p></div>

        </div>
        <H1 class="text_Habbies">Habbies</H1>
        <div class="div_Habbies_Friend_label"></div>
    </div>


</div>

</body>
</html>